@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using WebApiDocumentator.Areas.WebApiDocumentator.Pages
@using WebApiDocumentator.Metadata
@using WebApiDocumentator.Models
@using System.Text.Json
@model WebApiDocumentator.Areas.WebApiDocumentator.Pages.IndexModel
@{
    var selected = Model.SelectedEndpoint;
    var method = selected?.HttpMethod ?? "GET";
    var route = selected?.Route ?? "/default/route";
    var version = Model.GetApiVersion();
    var summary = selected?.Summary;
    var parameters = string.IsNullOrWhiteSpace(selected?.Description) ? new string[] { } : selected?.Description?.Split("\n") ?? new string[] { };
    ViewData["SelectedEndpoint"] = selected;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@Model.Name (@Model.Version) | Documentation</title>
    @Html.Raw(Style.GetStyles())
</head>
<body>
    <div id="content">
        @if(selected == null)
        {
            <div class="card">
                <h1>@Model.Name</h1>
                <h2>@Model.Version</h2>
                @if(!string.IsNullOrWhiteSpace(version))
                {
                    <a class="btn" href="/openapi/@(version).json" target="_blank">
                        OpenAPI @version
                    </a>
                }
                <p>@Model.Description</p>
                @if(!string.IsNullOrWhiteSpace(Model.ExampleBodyJson))
                {
                    <pre class="json-viewer">@Model.ExampleBodyJson</pre>
                }
                else
                {
                    <p>No return schema available.</p>
                }
            </div>
        }
        else
        {
            <div id="documentation-tabs">
                <div class="doc-tabs">
                    <div class="doc-tab active" data-tab="documentation">Documentation</div>
                    <div class="doc-tab" data-tab="testing">Test Endpoint</div>
                </div>

                <div class="doc-tab-content active" id="documentation-tab">
                    <div class="endpoint-header">
                        <span class="endpoint-method @selected.HttpMethod">@selected.HttpMethod</span>
                        <h1 class="endpoint-title">@selected.Route</h1>
                    </div>

                    <p class="endpoint-description">@summary</p>

                    @if(parameters.Any())
                    {
                        <div class="section">
                            <h3>Service Parameters</h3>
                            <ul>
                                @foreach(var param in parameters)
                                {
                                    <li>@param</li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="card">
                        <h3>Parameters</h3>
                        @if(selected.Parameters.Any())
                        {
                            <div style="overflow-x: auto;">
                                <table class="schema-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Required</th>
                                            <th>Source</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach(var param in selected.Parameters)
                                        {
                                            <tr>
                                                <td>@param.Name</td>
                                                <td>@param.Type</td>
                                                <td>@(param.IsRequired ? "Yes" : "No")</td>
                                                <td class="source @param.Source.ToLower()">@param.Source</td>
                                                <td>@param.Description</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p>No parameters.</p>
                        }
                    </div>

                    <div id="models-example">
                        <div class="models-tabs">
                            <div class="models-tab active" data-tab="request">Request</div>
                            <div class="models-tab" data-tab="response">Response</div>
                        </div>
                        <div class="card models-tab-content active" id="request-tab">
                            <h3>Request</h3>
                            @if(!string.IsNullOrWhiteSpace(Model.RequestBodyJson))
                            {
                                <pre class="json-viewer">@Model.RequestBodyJson</pre>
                            }
                            else
                            {
                                <p>No request schema available.</p>
                            }
                        </div>
                        <div class="card models-tab-content" id="response-tab">
                            <h3>Response</h3>
                            <p><strong>Type:</strong> @selected.ReturnType</p>
                            @if(!string.IsNullOrWhiteSpace(selected.ExampleJson))
                            {
                                <pre class="json-viewer">@Html.Raw(selected.ExampleJson)</pre>
                            }
                            else
                            {
                                <p>No return schema available.</p>
                            }
                        </div>
                    </div>
                </div>

                <div class="doc-tab-content" id="testing-tab">
                    <div class="card test-form">
                        <h3>Test this endpoint</h3>
                        <form method="post" action="@($"/{Model.DocsBaseUrl}?id={selected.Id}")" id="testForm" enctype="@Model.FormEnctype">
                            <input type="hidden" name="TestInput.Id" value="@selected.Id" />
                            <input type="hidden" name="TestInput.Method" value="@method" />
                            <input type="hidden" name="TestInput.Route" value="@route" />
                            @Html.AntiForgeryToken()

                            <div class="auth-section">
                                <input type="hidden" id="authTypeValue" name="authTypeValue" value="@Model.TestInput.Authentication.Type" />
                                <input type="hidden" id="apiKeyLocationValue" name="apiKeyLocationValue" value="@Model.TestInput.Authentication.ApiKeyLocation" />
                                <label for="authType">Authentication Type</label>
                                <select id="authType" name="TestInput.Authentication.Type" class="form-control" onchange="toggleAuthFields()">
                                    <option value="None">None</option>
                                    <option value="Bearer">Bearer Token</option>
                                    <option value="ApiKey">API Key</option>
                                    <option value="Basic">Basic Auth</option>
                                </select>

                                <div id="bearerFields" class="auth-fields @(Model.TestInput.Authentication.Type == AuthenticationType.Bearer ? "active" : "")">
                                    <label for="bearerToken">Bearer Token (Required)</label>
                                    <input type="text" id="bearerToken" name="TestInput.Authentication.BearerToken" value="@Model.TestInput.Authentication.BearerToken" placeholder="Enter Bearer Token" />
                                    @if(ModelState.ContainsKey("TestInput.Authentication.BearerToken"))
                                    {
                                        <div class="field-error">
                                            @ModelState["TestInput.Authentication.BearerToken"].Errors.FirstOrDefault()?.ErrorMessage
                                        </div>
                                    }
                                </div>

                                <div id="apiKeyFields" class="auth-fields @(Model.TestInput.Authentication.Type == AuthenticationType.ApiKey ? "active" : "")">
                                    <label for="apiKeyValue">API Key (Required)</label>
                                    <input type="text" id="apiKeyValue" name="TestInput.Authentication.ApiKeyValue" value="@Model.TestInput.Authentication.ApiKeyValue" placeholder="Enter API Key" />
                                    @if(ModelState.ContainsKey("TestInput.Authentication.ApiKeyValue"))
                                    {
                                        <div class="field-error">
                                            @ModelState["TestInput.Authentication.ApiKeyValue"].Errors.FirstOrDefault()?.ErrorMessage
                                        </div>
                                    }

                                    <label for="apiKeyName">Header/Parameter Name (Optional, defaults to 'X-Api-Key')</label>
                                    <input type="text" id="apiKeyName" name="TestInput.Authentication.ApiKeyName" value="@Model.TestInput.Authentication.ApiKeyName" placeholder="e.g., X-Api-Key" />
                                    @if(ModelState.ContainsKey("TestInput.Authentication.ApiKeyName"))
                                    {
                                        <div class="field-error">
                                            @ModelState["TestInput.Authentication.ApiKeyName"].Errors.FirstOrDefault()?.ErrorMessage
                                        </div>
                                    }

                                    <label for="apiKeyLocation">Location</label>
                                    <select id="apiKeyLocation" name="TestInput.Authentication.ApiKeyLocation" class="form-control">
                                        <option value="Header">Header</option>
                                        <option value="Query">Query</option>
                                    </select>
                                </div>

                                <div id="basicFields" class="auth-fields @(Model.TestInput.Authentication.Type == AuthenticationType.Basic ? "active" : "")">
                                    <label for="basicUsername">Username (Required)</label>
                                    <input type="text" id="basicUsername" name="TestInput.Authentication.BasicUsername" value="@Model.TestInput.Authentication.BasicUsername" placeholder="Enter Username" />
                                    <label for="basicPassword">Password (Required)</label>
                                    <input type="password" id="basicPassword" name="TestInput.Authentication.BasicPassword" value="@Model.TestInput.Authentication.BasicPassword" placeholder="Enter Password" />
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="clearAuth()">Clear Authentication</button>
                            </div>

                            @foreach(var param in selected.Parameters)
                            {
                                if(param.IsValueParameter)
                                {
                                    string value = Model.TestInput.Parameters.ContainsKey(param.Name) ? Model.TestInput.Parameters[param.Name] : Model.GenerateFlatSchema(param.Schema) ?? "";
                                    @if(param.IsFromBody)
                                    {
                                        var rows = Model.CountLinesInSchema(param.Schema);
                                        <div class="form-group">
                                            <label>@param.Name (@param.Type): @(param.IsRequired ? "Required" : "Optional")</label>
                                            <textarea name="TestInput.Parameters[@param.Name]"
                                                                  rows="@rows"
                                                                  placeholder="@(Model.GenerateFlatSchema(param.Schema) ?? "Enter JSON here")">@value
                                            </textarea>
                                        </div>
                                    }
                                    else if(param.Source == "Form")
                                    {
                                        <label>@param.Name (@param.Type): @(param.IsRequired ? "Required" : "Optional")</label>
                                        var formProps = Model.GetFormProperties(param.Type);
                                        foreach(var prop in formProps)
                                        {
                                            string propName = prop.Name;
                                            string fullKey = $"TestInput.Parameters[{propName}]";
                                            string currentValue = Model.TestInput.Parameters.ContainsKey($"{propName}")
                                            ? Model.TestInput.Parameters[$"{propName}"]
                                            : "";
                                            <div class="form-group">
                                                <label>@prop.Name (@prop.PropertyType.Name)</label>
                                                @if(prop.PropertyType == typeof(bool))
                                                {
                                                    <input type="checkbox"
                                                           name="@fullKey"
                                                           value="true"
                                                           @(currentValue == "true" ? "checked" : "") />
                                                }
                                                else if(prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?))
                                                {
                                                    <input type="datetime-local"
                                                           name="@fullKey"
                                                           value="@currentValue"
                                                           placeholder="yyyy-MM-ddTHH:mm" />
                                                }
                                                else if(prop.PropertyType == typeof(byte[]) || 
                                                        prop.PropertyType.Name == "IFormFile" || 
                                                        prop.PropertyType.Name == "IFormFileCollection")
                                                {
                                                    fullKey = $"TestInput.Files[{param.Name}]";
                                                    <input type="file" name="@fullKey" />
                                                }
                                                else
                                                {
                                                    <input type="text"
                                                           name="@fullKey"
                                                           value="@currentValue"
                                                           placeholder="@prop.PropertyType.Name" />
                                                }

                                                @if(ModelState.ContainsKey(fullKey))
                                                {
                                                    <div class="field-error">
                                                        @ModelState[fullKey].Errors.FirstOrDefault()?.ErrorMessage
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                    else if(param.IsCollection && param.Source == "Query")
                                    {
                                        // Nuevo código para manejar arrays en query string
                                        <div class="form-group collection-parameter" data-param-name="@param.Name" data-param-type="@param.CollectionElementType">
                                            <label>
                                                @param.Name (@(param.CollectionElementType + "[]")) - @(param.IsRequired ? "Required" : "Optional")
                                                <button type="button" class="btn-add-item">+ Add Item</button>
                                            </label>
                                            <div class="collection-items">
                                                @{
                                                    var items = Model.TestInput.Collections.ContainsKey(param.Name)
                                                    ? Model.TestInput.Collections[param.Name]
                                                    : new List<string>();

                                                    for(int i = 0; i < items.Count; i++)
                                                    {
                                                        <div class="collection-item">
                                                            <input type="text"
                                                                   name="TestInput.Collections[@param.Name][@i]"
                                                                   value="@items[i]"
                                                                   placeholder="@param.CollectionElementType" />
                                                            <button type="button" class="btn-remove-item">×</button>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="form-group">
                                            <label>@param.Name (@param.Type): @(param.IsRequired ? "Required" : "Optional")</label>
                                            <input type="text"
                                                   name="TestInput.Parameters[@param.Name]"
                                                   value="@value"
                                                   placeholder="@(param.IsRequired ? "Required" : "Optional")" />
                                        </div>
                                    }
                                    @if(ModelState.ContainsKey($"TestInput.Parameters[{param.Name}]"))
                                    {
                                        <div class="field-error">
                                            @ModelState[$"TestInput.Parameters[{param.Name}]"].Errors.FirstOrDefault()?.ErrorMessage
                                        </div>
                                    }
                                }
                            }
                            @if(!ModelState.IsValid &&
                                                    ModelState
                                                    .Where(kvp => !kvp.Key.StartsWith("TestInput.Parameters["))
                                                    .Any(state => state.Value?.Errors?.Any(e => !string.IsNullOrWhiteSpace(e.ErrorMessage)) ?? false))
                            {
                                <div class="error-message">
                                    <ul>
                                        @foreach(var error in ModelState.Where(kvp => !kvp.Key.StartsWith("TestInput.Parameters[")))
                                        {
                                            foreach(var err in error.Value.Errors)
                                            {
                                                if(!string.IsNullOrWhiteSpace(err.ErrorMessage))
                                                {
                                                    <li>
                                                        @err.ErrorMessage
                                                    </li>
                                                }
                                            }
                                        }
                                    </ul>
                                </div>
                            }


                            <button type="submit" class="btn" id="submitBtn">Send Request</button>
                            <div class="loading" id="loadingIndicator">
                                <div class="loading-spinner"></div>
                                <p>Sending request...</p>
                            </div>
                        </form>

                        @if(Model.TestResponse != null)
                        {
                            <div class="card">
                                <h4>Response @Model.ResponseCodeDescription</h4>
                                <pre class="json-viewer">@Html.Raw(Model.TestResponse)</pre>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @if(selected != null)
    {
        <div id="examples">
            <h3>Examples</h3>
            <div class="example-tabs">
                <div class="example-tab active" data-tab="curl">cURL</div>
                <div class="example-tab" data-tab="csharp">C#</div>
                <div class="example-tab" data-tab="javascript">JavaScript</div>
            </div>

            <div class="example-tab-content active" id="curl-tab">
                <div class="example-header">
                    <button class="copy-btn" data-target="curl-example">Copy</button>
                </div>
                <pre id="curl-example">curl -X @selected.HttpMethod @($"{Model.BaseUrl}/{Model.ExampleRequestUrl.TrimStart('/')}")
                            @if(!string.IsNullOrWhiteSpace(Model.RequestBodyJson))
                            {
                    <text>     -H "Content-Type: application/json"
             -d '@Html.Raw(Model.RequestBodyJson)'</text>
                            }
        </pre>
            </div>

            <div class="example-tab-content" id="csharp-tab">
                <div class="example-header">
                    <button class="copy-btn" data-target="csharp-example">Copy</button>
                </div>
                <pre id="csharp-example">using var client = new HttpClient();
    client.BaseAddress = new Uri("@Model.BaseUrl");
                            @if(!string.IsNullOrWhiteSpace(Model.RequestBodyJson))
                            {
                    <text>using var content = new StringContent(@Html.Raw(Model.RequestBodyJson), System.Text.Encoding.UTF8, "application/json");
        using var response = await client.@(Model.HttpMethodFormatted)Async("@Model.ExampleRequestUrl", content);</text>
                            }
                            else
                            {
                    <text>using var response = await client.@(Model.HttpMethodFormatted)Async("@Model.ExampleRequestUrl");</text>
                            }
    response.EnsureSuccessStatusCode();
    var content = await response.Content.ReadAsStringAsync();</pre>
            </div>

            <div class="example-tab-content" id="javascript-tab">
                <div class="example-header">
                    <button class="copy-btn" data-target="javascript-example">Copy</button>
                </div>
                <pre id="javascript-example">fetch("@($"{Model.BaseUrl}/{Model.ExampleRequestUrl.TrimStart('/')}")", {
         method: "@selected.HttpMethod",
                            @if(!string.IsNullOrWhiteSpace(Model.RequestBodyJson))
                            {
                    <text>     headers: { "Content-Type": "application/json" },
             body: @Html.Raw(Model.RequestBodyJson)</text>
                            }
    })
    .then(res => res.json())
    .then(data => console.log(data));</pre>
            </div>
        </div>
    }


    <button class="sidebar-toggle active" id="sidebarToggle">
        |||
    </button>

    <div id="sidebar" class="active">
        <div class="sidebar-header">
            <a href="/@Model.DocsBaseUrl">
                <h3>@Model.Name</h3>
            </a>
        </div>

        <div class="sidebar-search">
            <input type="text" id="searchEndpoints" placeholder="Search endpoints...">
        </div>

        <div class="sidebar-title">
            <span class="toggle-all" id="toggleAll">Expand All</span>
        </div>

        <partial name="EndpointNode" model="Model.Groups" view-data="ViewData" />
    </div>

    <script>
        function initAuthFields() {
            var authTypeItem = document.getElementById("authTypeValue");
            if (authTypeItem) {
                document.getElementById("authType").value = authTypeItem.value;
            }

            var apiKeyLocationItem = document.getElementById("apiKeyLocationValue");
            if (apiKeyLocationItem) {
                document.getElementById("apiKeyLocation").value = apiKeyLocationItem.value;
            }

            toggleAuthFields();
        }

        function toggleAuthFields() {
            var authType = document.getElementById("authType");

            if (authType) {
                var bearerFields = document.getElementById("bearerFields");
                var apiKeyFields = document.getElementById("apiKeyFields");
                var basicFields = document.getElementById("basicFields");

                bearerFields.classList.remove("active");
                apiKeyFields.classList.remove("active");
                basicFields.classList.remove("active");

                if (authType.value === "Bearer") {
                    bearerFields.classList.add("active");
                } else if (authType.value === "ApiKey") {
                    apiKeyFields.classList.add("active");
                } else if (authType.value === "Basic") {
                    basicFields.classList.add("active");
                }
            }
        }

        function clearAuth() {
            document.getElementById("authType").value = "None";
            document.getElementById("bearerToken").value = "";
            document.getElementById("apiKeyValue").value = "";
            document.getElementById("apiKeyName").value = "";
            document.getElementById("apiKeyLocation").value = "Header";
            document.getElementById("basicUsername").value = "";
            document.getElementById("basicPassword").value = "";
            toggleAuthFields();
            fetch('/Docs?handler=ClearAuth', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            }).then(response => {
                if (response.ok) {
                    console.log("Authentication cleared");
                }
            });
        }

        function setupExampleTabs() {
            const tabs = document.querySelectorAll('.example-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.example-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.example-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        function setupModelsTabs() {
            const tabs = document.querySelectorAll('.models-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.models-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.models-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        function setupMobileSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    sidebarToggle.classList.toggle('active');
                });
            }
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) &&
                    e.target !== sidebarToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.classList.remove('active');
                }
            });
        }

        function setupCollapsibleGroups() {
            const groupHeaders = document.querySelectorAll('.group-header');
            const toggleAllBtn = document.getElementById('toggleAll');
            let allCollapsed = true;

            calculateAllGroupHeights();
            groupHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target === toggleAllBtn) return;

                    const groupItems = header.nextElementSibling;
                    const toggle = header.querySelector('.group-toggle');

                    toggleGroup(groupItems, toggle);
                });
            });
            if (toggleAllBtn) {
                toggleAllBtn.addEventListener('click', () => {
                    allCollapsed = !allCollapsed;
                    toggleAllBtn.textContent = allCollapsed ? 'Expand All' : 'Collapse All';

                    groupHeaders.forEach(header => {
                        const groupItems = header.nextElementSibling;
                        const toggle = header.querySelector('.group-toggle');

                        if (allCollapsed) {
                            collapseGroup(groupItems, toggle);
                        } else {
                            expandGroup(groupItems, toggle);
                        }
                    });
                });
            }
        }

        function calculateAllGroupHeights() {
            const allGroups = Array.from(document.querySelectorAll('.group-items'));

            allGroups.sort((a, b) => {
                const depthA = getDepth(a);
                const depthB = getDepth(b);
                return depthB - depthA;
            });

            allGroups.forEach(group => {
                const height = calculateGroupHeightRecursive(group);
                group.dataset.calculatedHeight = height;
            });
        }

        function getDepth(element) {
            let depth = 0;
            let current = element;

            while (current) {
                depth++;
                current = current.parentElement.closest('.group-items');
            }
            return depth;
        }

        function calculateGroupHeightRecursive(groupElement) {
            let height = 0;

            Array.from(groupElement.children).forEach(child => {
                if (child.style.display === 'none') return;
                const style = window.getComputedStyle(child);
                const margin = parseInt(style.marginTop) + parseInt(style.marginBottom);
                height += child.offsetHeight + margin;
                if (child.classList.contains('group-items')) {
                    if (child.style.maxHeight && child.style.maxHeight !== '0px') {
                        height += parseInt(child.dataset.calculatedHeight || calculateGroupHeightRecursive(child));
                    }
                }
                else if (child.classList.contains('endpoint-list')) {
                    Array.from(child.children).forEach(grandChild => {
                        if (grandChild.classList.contains('endpoint-group')) {
                            const items = grandChild.querySelector('.group-items');
                            if (items) {
                                if (items.style.maxHeight && items.style.maxHeight !== '0px') {
                                    height += parseInt(items.dataset.calculatedHeight || calculateGroupHeightRecursive(items));
                                }
                            }
                        }
                    });
                }
            });
            return height;
        }

        function expandGroup(groupItems, toggle) {
            const height = calculateGroupHeightRecursive(groupItems);
            groupItems.dataset.calculatedHeight = height;
            groupItems.style.maxHeight = height + 'px';
            if (toggle) toggle.classList.remove('collapsed');
            let parentGroup = groupItems.parentElement.closest('.group-items');
            while (parentGroup) {
                const parentHeight = calculateGroupHeightRecursive(parentGroup);
                parentGroup.dataset.calculatedHeight = parentHeight;
                parentGroup.style.maxHeight = parentHeight + 'px';
                const parentHeader = parentGroup.previousElementSibling;
                if (parentHeader && parentHeader.classList.contains('group-header')) {
                    const parentToggle = parentHeader.querySelector('.group-toggle');
                    if (parentToggle) parentToggle.classList.remove('collapsed');
                }
                parentGroup = parentGroup.parentElement.closest('.group-items');
            }
        }

        function collapseGroup(groupItems, toggle) {
            groupItems.style.maxHeight = '0';
            if (toggle) toggle.classList.add('collapsed');
        }

        function toggleGroup(groupItems, toggle) {
            if (groupItems.style.maxHeight !== '0px') {
                collapseGroup(groupItems, toggle);
            } else {
                expandGroup(groupItems, toggle);
            }
        }

        function initMenu() {
            document.querySelectorAll('.group-items').forEach(group => {
                group.style.maxHeight = '0';
            });
            setTimeout(() => {
                calculateAllGroupHeights();

                const selectedLink = document.querySelector('.endpoint-link.selected');
                if (selectedLink) {
                    let currentGroup = selectedLink.closest('.group-items');
                    while (currentGroup) {
                        const toggle = currentGroup.previousElementSibling?.querySelector('.group-toggle');
                        expandGroup(currentGroup, toggle);
                        currentGroup = currentGroup.parentElement.closest('.group-items');
                    }
                }
            }, 100);
        }

        function setupEndpointSearch() {
            const searchInput = document.getElementById('searchEndpoints');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const endpointLinks = document.querySelectorAll('.endpoint-link');
                    endpointLinks.forEach(link => {
                        link.style.display = 'none';
                    });

                    endpointLinks.forEach(link => {
                        const text = link.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            link.style.display = 'flex';
                            let parentGroup = link.closest('.group-items');
                            while (parentGroup) {
                                parentGroup.style.display = 'block';
                                expandGroup(parentGroup);

                                const header = parentGroup.previousElementSibling;
                                if (header && header.classList.contains('group-header')) {
                                    header.style.display = 'flex';
                                }

                                parentGroup = parentGroup.parentElement.closest('.group-items');
                            }
                        }
                    });
                    document.querySelectorAll('.group-items').forEach(group => {
                        const visibleItems = group.querySelectorAll('.endpoint-link[style="display: flex;"]').length;
                        const childGroups = group.querySelectorAll('.group-items');
                        let childVisible = false;
                        childGroups.forEach(child => {
                            if (child.style.display !== 'none') {
                                childVisible = true;
                            }
                        });
                        if (visibleItems === 0 && !childVisible) {
                            group.style.display = 'none';
                            const header = group.previousElementSibling;
                            if (header && header.classList.contains('group-header')) {
                                header.style.display = 'none';
                            }
                        } else {
                            group.style.display = 'block';
                            const header = group.previousElementSibling;
                            if (header && header.classList.contains('group-header')) {
                                header.style.display = 'flex';
                            }
                        }
                    });
                });
            }
        }

        function collapseAllExceptSelected() {
            const selectedLink = document.querySelector('.endpoint-link.selected');
            document.querySelectorAll('.group-items').forEach(group => {
                collapseGroup(group);
            });
            if (selectedLink) {
                let currentGroup = selectedLink.closest('.group-items');
                while (currentGroup) {
                    expandGroup(currentGroup);
                    currentGroup = currentGroup.parentElement.closest('.group-items');
                }
            }
        }

        function scrollToSelectedEndpoint() {
            const selectedLink = document.querySelector('.endpoint-link.selected');
            if (selectedLink) {
                collapseAllExceptSelected();
                setTimeout(() => {
                    selectedLink.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }

        function setupFormLoadingIndicator() {
            const form = document.getElementById('testForm');
            if (form) {
                form.addEventListener('submit', () => {
                    const submitBtn = document.getElementById('submitBtn');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    submitBtn.style.display = 'none';
                    loadingIndicator.style.display = 'block';
                });
            }
        }
        function setupCopyButtons() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const codeElement = document.getElementById(targetId);

                    if (codeElement) {
                        const textToCopy = codeElement.textContent;
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            this.textContent = 'Copied!';
                            this.classList.add('copied');
                            setTimeout(() => {
                                this.textContent = 'Copy';
                                this.classList.remove('copied');
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                        });
                    }
                });
            });
        }

        function setupDocumentationTabs() {
            const tabs = document.querySelectorAll('.doc-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchToTab(tab.getAttribute('data-tab'));
                });
            });
            let testResponse = @Html.Raw(JsonSerializer.Serialize(Model.TestResponse));
            if (testResponse && testResponse.length > 1)
            {
                setTimeout(() => {
                    switchToTab('testing');
                }, 100);
            }
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.doc-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.doc-tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

                function setupCollectionParameters() {
            // Manejar agregar nuevos elementos a colecciones
            document.querySelectorAll('.btn-add-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const container = this.closest('.collection-parameter');
                    const itemsContainer = container.querySelector('.collection-items');
                    const paramName = container.dataset.paramName;
                    const paramType = container.dataset.paramType;
                    const itemCount = itemsContainer.querySelectorAll('.collection-item').length;

                    const newItem = document.createElement('div');
                    newItem.className = 'collection-item';
                    newItem.innerHTML = `
                        <input type="text"
                               name="TestInput.Collections[${paramName}][${itemCount}]"
                               placeholder="${paramType}" />
                        <button type="button" class="btn-remove-item">×</button>
                    `;

                    itemsContainer.appendChild(newItem);

                    // Configurar el evento de eliminación para el nuevo elemento
                    newItem.querySelector('.btn-remove-item').addEventListener('click', function() {
                        newItem.remove();
                        reindexCollectionItems(container);
                    });
                });
            });

            // Manejar eliminación de elementos de colecciones
            document.querySelectorAll('.btn-remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const item = this.closest('.collection-item');
                    const container = item.closest('.collection-parameter');
                    item.remove();
                    reindexCollectionItems(container);
                });
            });
        }

        function reindexCollectionItems(container) {
            const items = container.querySelectorAll('.collection-item');
            items.forEach((item, index) => {
                const input = item.querySelector('input');
                const oldName = input.name;
                const paramName = oldName.match(/TestInput\.Collections\[(.*?)\]/)[1];
                input.name = `TestInput.Collections[${paramName}][${index}]`;
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            initAuthFields();
            setupModelsTabs();
            setupExampleTabs();
            setupMobileSidebar();
            setupEndpointSearch();
            setupCollapsibleGroups();
            collapseAllExceptSelected();
            setupFormLoadingIndicator();
            setupCopyButtons();
            initMenu();
            setupDocumentationTabs();
            scrollToSelectedEndpoint();
            setupCollectionParameters();
        });
    </script>
</body>
</html>